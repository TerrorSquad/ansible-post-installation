---
- name: Install git
  apt:
    name:
      - git

- name: Save current git name
  git_config:
    name: "user.name"
    scope: global
  become_user: "{{ username }}"
  register: current_git_name

- name: Save current git email
  git_config:
    name: "user.email"
    scope: global
  become_user: "{{ username }}"
  register: current_git_email

- name: Copy .gitconfig file
  copy:
    src: ./defaults/.gitconfig
    dest: "~"
  become_user: "{{ username }}"

- name: Download and install delta
  block:
    - name: Download delta page
      get_url:
        url: https://github.com/dandavison/delta/releases/
        dest: "{{ download_dir }}/delta.html"
    - name: Download delta package
      shell: |
        A=https://github.com/; B=$(grep -oP "/.+_amd64\.deb" "{{ download_dir }}/delta.html" | grep -v musl | head -n 1); echo $A$B | xargs wget -O "{{ download_dir }}/delta.deb"
    - name: Install delta
      apt:
        deb: "{{ download_dir }}/delta.deb"
        force: true

- block:
    - name: Configure git with default user name
      git_config:
        name: "user.name"
        value: "{{ git_user_name }}"
        scope: global
        state: present
      become_user: "{{ username }}"

    - name: Configure git with default user email
      git_config:
        name: "user.email"
        value: "{{ git_user_email }}"
        scope: global
        state: present
      become_user: "{{ username }}"
  when: git_set_user_data == True

- block:
    - name: Configure git with default user name
      git_config:
        name: "user.name"
        value: "{{ current_git_name.config_value }}"
        scope: global
        state: present
      become_user: "{{ username }}"

    - name: Configure git with default user email
      git_config:
        name: "user.email"
        value: "{{ current_git_email.config_value }}"
        scope: global
        state: present
      become_user: "{{ username }}"
  when: git_set_user_data == False
