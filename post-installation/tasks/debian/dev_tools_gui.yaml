---
- name: Install common apt dev tools
  ansible.builtin.apt:
    name:
      - kcachegrind
      - graphviz

- name: Install GNOME/GTK specific terminals
  ansible.builtin.apt:
    name:
      - guake
      - terminator
  when: "ansible_env.XDG_CURRENT_DESKTOP is defined and ('GNOME' in ansible_env.XDG_CURRENT_DESKTOP or 'Cinnamon' in ansible_env.XDG_CURRENT_DESKTOP or 'X-Cinnamon' in ansible_env.XDG_CURRENT_DESKTOP)"

- name: Install KDE specific terminals
  ansible.builtin.apt:
    name:
      - yakuake
      - konsole
  when: "ansible_env.XDG_CURRENT_DESKTOP is defined and ('KDE' in ansible_env.XDG_CURRENT_DESKTOP)"

- name: Download and install GitKraken
  ansible.builtin.include_tasks: shared/utils/install_remote_deb.yaml
  vars:
    remote_software_name: GitKraken
    remote_package_name: gitkraken
    remote_software_url: https://release.axocdn.com/linux/gitkraken-amd64.deb

- name: Download and install DBeaver
  ansible.builtin.include_tasks: shared/utils/install_remote_deb.yaml
  vars:
    remote_software_name: DBeaver
    remote_package_name: dbeaver-ce
    remote_software_url: https://dbeaver.io/files/dbeaver-ce_latest_amd64.deb

- name: Download and install Slack
  block:
    - name: Download Slack page
      ansible.builtin.get_url:
        url: https://slack.com/downloads/instructions/linux?build=deb
        dest: "{{ download_dir }}/slack.html"
        mode: "0644"

    - name: Find out latest Slack URL
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          grep -oP "https://downloads.*?\.deb" "{{ download_dir }}/slack.html" | head -n 1
        executable: "{{ bash_executable }}"
      register: slack_url_result
      changed_when: slack_url_result.rc == 0

    - name: Install Slack
      ansible.builtin.include_tasks: shared/utils/install_remote_deb.yaml
      vars:
        remote_software_name: Slack
        remote_package_name: slack-desktop
        remote_software_url: "{{ slack_url_result.stdout }}"

- name: Create Terminator config directory path
  ansible.builtin.file:
    dest: "{{ terminator_config_dir }}"
    state: directory
    mode: "0775"
  become_user: "{{ username }}"
  become: true
  when: "ansible_env.XDG_CURRENT_DESKTOP is defined and ('GNOME' in ansible_env.XDG_CURRENT_DESKTOP or 'Cinnamon' in ansible_env.XDG_CURRENT_DESKTOP or 'X-Cinnamon' in ansible_env.XDG_CURRENT_DESKTOP)"

- name: Configure Terminator
  ansible.builtin.copy:
    src: "{{ role_path }}/defaults/.config/terminator/config"
    dest: "{{ terminator_config_file }}"
    mode: "0644"
  become_user: "{{ username }}"
  become: true
  when: "ansible_env.XDG_CURRENT_DESKTOP is defined and ('GNOME' in ansible_env.XDG_CURRENT_DESKTOP or 'Cinnamon' in ansible_env.XDG_CURRENT_DESKTOP or 'X-Cinnamon' in ansible_env.XDG_CURRENT_DESKTOP)"

- name: Download and install JetBrains ToolBox
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      curl -fsSL https://raw.githubusercontent.com/terrorsquad/jetbrains-toolbox-install/master/jetbrains-toolbox.sh | zsh
    executable: "{{ bash_executable }}"
  become_user: "{{ username }}"
  become: true
  register: jetbrains_toolbox_installed
  changed_when: jetbrains_toolbox_installed.rc == 0

- name: Download and install Visual Studio Code
  when: not (is_wsl | default(false))
  block:
    - name: Download and install Visual Studio Code
      ansible.builtin.include_tasks: shared/utils/install_remote_deb.yaml
      vars:
        remote_software_name: Visual Studio Code
        remote_package_name: code
        remote_software_url: https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64

- name: Install Postman
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      curl https://gist.githubusercontent.com/SanderTheDragon/1331397932abaa1d6fbbf63baed5f043/raw/postman-deb.sh | zsh
    chdir: "{{ download_dir }}"
    executable: "{{ bash_executable }}"
  become_user: "{{ username }}"
  become: true
  register: postman_installed
  changed_when: postman_installed.rc == 0

- name: Sublime text
  block:
    - name: Download Sublime Text GPG key to tmp
      ansible.builtin.get_url:
        url: https://download.sublimetext.com/sublimehq-pub.gpg
        dest: /tmp/sublimehq-pub.gpg
        mode: "0644"
      become: true

    - name: Remove invalid Sublime Text keyring (ASCII)
      ansible.builtin.shell: |
        if [ -f /usr/share/keyrings/sublimehq-archive.gpg ] && grep -q "BEGIN PGP PUBLIC KEY BLOCK" /usr/share/keyrings/sublimehq-archive.gpg; then
          rm /usr/share/keyrings/sublimehq-archive.gpg
          echo "removed"
        fi
      register: remove_ascii_key
      changed_when: "'removed' in remove_ascii_key.stdout"
      become: true

    - name: Dearmor and install Sublime Text GPG key
      ansible.builtin.shell: |
        gpg --dearmor < /tmp/sublimehq-pub.gpg > /usr/share/keyrings/sublimehq-archive.gpg
      args:
        creates: /usr/share/keyrings/sublimehq-archive.gpg
      become: true

    - name: Add Sublime Text apt repository (use signed-by)
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/sublimehq-archive.gpg] https://download.sublimetext.com/ apt/stable/"
        filename: sublime-text
        state: present
        update_cache: true

    - name: Install dependencies
      ansible.builtin.apt:
        name:
          - ca-certificates
          - apt-transport-https
        state: present

    - name: Add sublime text
      ansible.builtin.apt:
        name:
          - sublime-text

- name: Install Zed editor
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      curl -f https://zed.dev/install.sh | sh
    executable: "{{ bash_executable }}"
  become_user: "{{ username }}"
  become: false
  register: zed_installed
  changed_when: zed_installed.rc == 0
  ignore_errors: true
