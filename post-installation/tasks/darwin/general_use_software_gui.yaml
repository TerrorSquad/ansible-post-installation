---
- name: Check which GUI applications are already installed via Homebrew Cask
  ansible.builtin.shell: brew list --cask {{ item }} 2>/dev/null
  loop:
    - visual-studio-code
    - google-chrome
    - slack
    - zoom
    - skype
    - vlc
    - postman
    - dbeaver-community
    - gitkraken
    - sublime-text
    - microsoft-teams
    - viber
    # - onlyoffice  # Temporarily disabled to test password prompt
    - adguard-vpn
    - ticktick
    - whatsapp
  register: existing_casks
  failed_when: false
  changed_when: false

- name: Install GUI applications via Homebrew Cask (only if not conflicting)
  community.general.homebrew_cask:
    name: "{{ item }}"
    state: latest
    upgrade_all: false
    sudo_password: null
  environment:
    HOMEBREW_CASK_OPTS: "--no-quarantine"
    HOMEBREW_NO_AUTO_UPDATE: "1"
  loop:
    - visual-studio-code
    - google-chrome
    - slack
    - zoom
    - skype
    - vlc
    - postman
    - dbeaver-community
    - gitkraken
    - sublime-text
    - microsoft-teams
    - viber
    # - onlyoffice  # Temporarily disabled to test password prompt
    - adguard-vpn
    - ticktick
    - whatsapp
  retries: 3
  register: gui_cask_results
  failed_when: false

- name: GUI applications installation summary
  ansible.builtin.debug:
    msg:
      - "GUI Applications Summary:"
      - "  Installed/Updated: {{ gui_cask_results.results | selectattr('changed', 'equalto', true) | list | length }}"
      - "  Already up-to-date: {{ gui_cask_results.results | rejectattr('changed') | rejectattr('failed') | list | length }}"
      - "  Failed/Skipped: {{ gui_cask_results.results | selectattr('failed', 'equalto', true) | list | length }}"

- name: Install productivity and utility applications via Homebrew Cask
  community.general.homebrew_cask:
    name: "{{ item }}"
    state: latest
    upgrade_all: false
  environment:
    HOMEBREW_CASK_OPTS: "--no-quarantine"
    HOMEBREW_NO_AUTO_UPDATE: "1"
  loop:
    - alt-tab
    - autoraise
    - appcleaner
    - betterdisplay
    - copyclip
    - mos
    - rectangle
    - shottr
    - unzipone
  retries: 3
  register: utility_cask_results
  failed_when: false

- name: Utility applications installation summary
  ansible.builtin.debug:
    msg:
      - "Utility Applications Summary:"
      - "  Installed/Updated: {{ utility_cask_results.results | selectattr('changed', 'equalto', true) | list | length }}"
      - "  Already up-to-date: {{ utility_cask_results.results | rejectattr('changed') | rejectattr('failed') | list | length }}"
      - "  Failed/Skipped: {{ utility_cask_results.results | selectattr('failed', 'equalto', true) | list | length }}"
