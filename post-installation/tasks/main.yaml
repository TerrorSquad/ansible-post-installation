---
# ==============================================================================
# GRIFFIN: Cross-Platform Post-Installation Automation
# ==============================================================================

- name: Load OS-specific variables
  ansible.builtin.include_vars: "{{ ansible_facts['os_family'] | lower }}.yaml"
  tags: [always]

- name: Detect if running on WSL
  ansible.builtin.set_fact:
    is_wsl: "{{ 'microsoft' in ansible_facts['kernel'] | lower or 'wsl' in ansible_facts['kernel'] | lower }}"
  tags: [always]

- name: Enable features based on specific tags (when not using 'all')
  ansible.builtin.set_fact:
    gui: "{{ true if 'gui' in ansible_run_tags else gui }}"
    dev_tools_gui: "{{ true if 'dev-tools' in ansible_run_tags else dev_tools_gui }}"
    docker: "{{ true if 'docker' in ansible_run_tags else docker }}"
    rust: "{{ true if 'rust' in ansible_run_tags else rust }}"
    golang: "{{ true if 'golang' in ansible_run_tags else golang }}"
    java: "{{ true if 'java' in ansible_run_tags else java }}"
    ddev: "{{ true if 'ddev' in ansible_run_tags else ddev }}"
    vpn: "{{ true if 'vpn' in ansible_run_tags else vpn }}"
    fonts: "{{ true if 'fonts' in ansible_run_tags else fonts }}"
  when: ansible_run_tags | difference(['all', 'always']) | length > 0
  tags: [always]

- name: System preparation and basic setup
  ansible.builtin.include_tasks:
    file: "{{ ansible_facts['os_family'] | lower }}/system_setup.yaml"
    apply:
      tags: [system, setup]
  tags: [always]

- name: Install and configure Homebrew
  ansible.builtin.include_tasks:
    file: "{{ ansible_facts['os_family'] | lower }}/homebrew.yaml"
    apply:
      tags: [homebrew, packages]
  tags: [always]

- name: Shell and terminal configuration
  ansible.builtin.include_tasks:
    file: shared/shell_environment.yaml
    apply:
      tags: [shell, zsh, dotfiles]
  tags: [always]

- name: Version control and editors
  ansible.builtin.include_tasks:
    file: shared/development_foundation.yaml
    apply:
      tags: [dev, git, editors]
  tags: [always]

- name: Programming language environments
  ansible.builtin.include_tasks:
    file: shared/programming_languages.yaml
    apply:
      tags: [languages, programming, rust, golang, java]
  when: (rust | bool) or (golang | bool) or (java | bool) or (all | bool)
  tags: [always]

- name: Development tools and containerization
  ansible.builtin.include_tasks:
    file: shared/development_tools.yaml
    apply:
      tags: [dev-tools, docker, ddev, fonts, vpn]
  tags: [always]

- name: GUI applications and tools
  ansible.builtin.include_tasks:
    file: "{{ ansible_facts['os_family'] | lower }}/gui_applications.yaml"
    apply:
      tags: [gui]
  when: (gui | bool) or (dev_tools_gui | bool) or (all | bool)
  tags: [always]

- name: Cleanup and finalization
  ansible.builtin.include_tasks:
    file: shared/finalization.yaml
    apply:
      tags: [cleanup]
  tags: [always]

- name: Display completion message
  ansible.builtin.debug:
    msg:
      - "ðŸŽ‰ Griffin installation complete!"
      - "Please restart your machine to ensure all changes take effect."
      - "Check the documentation at: https://terrorsquad.github.io/ansible-post-installation/"
