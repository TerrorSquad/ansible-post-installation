---
- name: Install Docker (Linux)
  block:
    - name: Install depdendencies
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg-agent
          - software-properties-common

    - name: Add Docker apt repository key
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker apt repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ubuntu_codename }} stable"
        filename: docker-ce
        state: present
        update_cache: true

    - name: Update apt cache and install docker
      ansible.builtin.apt:
        update_cache: true
        name:
          - containerd.io
          - docker-ce
          - docker-ce-cli

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ username }}"
        groups: docker
        append: true
  when: ansible_os_family == 'Debian'

- name: Install Docker (macOS)
  block:
    - name: Check if Docker Desktop is already installed
      ansible.builtin.stat:
        path: /Applications/Docker.app
      register: docker_app_exists

    - name: Install Docker Desktop via Homebrew Cask
      community.general.homebrew_cask:
        name: docker
        state: present
        path: "{{ homebrew_path }}"
      when: not docker_app_exists.stat.exists
      register: docker_install_result
      failed_when: false

    - name: Log Docker installation status
      ansible.builtin.debug:
        msg: "Docker Desktop {{ 'already installed' if docker_app_exists.stat.exists else ('installed successfully' if docker_install_result.changed else 'installation skipped or failed') }}"
  when: ansible_os_family == 'Darwin'

- name: Ensure download directory exists
  ansible.builtin.file:
    path: "{{ download_dir }}"
    state: directory
    mode: '0755'

- name: Install docker-compose (Cross-platform)
  ansible.builtin.include_tasks: utils/install_github_asset.yaml
  vars:
    github_repo: docker/compose
    github_asset: docker-compose
    type: binary
    excluded_os_filter: "sha256sum"
    architecture_filter: "{{ docker_compose_architecture[ansible_architecture] }}"
