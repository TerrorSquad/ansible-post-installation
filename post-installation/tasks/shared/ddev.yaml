---
# Linux installation
- name: Install DDEV (Linux)
  when: ansible_facts['os_family'] == 'Debian'
  block:
    - name: Ensure /etc/apt/keyrings exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Cleanup broken DDEV key (fix extension mismatch)
      ansible.builtin.file:
        path: /etc/apt/keyrings/ddev.gpg
        state: absent

    - name: Download DDEV GPG key (ASCII) to keyring
      ansible.builtin.get_url:
        url: https://pkg.ddev.com/apt/gpg.key
        # CHANGE 1: Use .asc extension for ASCII keys
        dest: /etc/apt/keyrings/ddev.asc
        mode: "0644"
      register: apt_key_result
      until: apt_key_result is success
      retries: 3
      delay: 2
      become: true

    - name: Add DDEV package repository
      ansible.builtin.apt_repository:
        # CHANGE 2: Point to the .asc file
        repo: "deb [signed-by=/etc/apt/keyrings/ddev.asc] https://pkg.ddev.com/apt/ * *"
        filename: ddev
        state: present

    - name: Install DDEV
      ansible.builtin.apt:
        name: ddev
        state: present
        update_cache: true

    - name: Configure mkcert
      block:
        - name: Ensure mkcert data directory exists
          ansible.builtin.file:
            path: "/home/{{ username }}/.local/share/mkcert"
            state: directory
            owner: "{{ username }}"
            group: "{{ username }}"
            mode: '0700'

        - name: Initialize mkcert (As Root, pointing to User Home)
          ansible.builtin.command: mkcert -install
          environment:
            # Force mkcert to read/write keys in YOUR home dir, not /root/
            CAROOT: "/home/{{ username }}/.local/share/mkcert"
          become: true

        - name: Fix ownership of generated certificates
          ansible.builtin.file:
            path: "/home/{{ username }}/.local/share/mkcert"
            owner: "{{ username }}"
            group: "{{ username }}"
            recurse: yes
          become: true

# macOS installation
- name: Install DDEV and mkcert (macOS)
  when: ansible_facts['os_family'] == 'Darwin'
  block:
    - name: Add DDEV tap
      community.general.homebrew_tap:
        name: ddev/ddev
        state: present
      register: tap_result
      until: tap_result is success
      retries: 3
      delay: 2
      become: false

    - name: Install DDEV via Homebrew
      community.general.homebrew:
        name: ddev/ddev/ddev
        state: present
        path: "{{ homebrew_path }}"
      register: brew_ddev_result
      until: brew_ddev_result is success
      retries: 3
      delay: 2
      become: false

    - name: Install mkcert via Homebrew
      community.general.homebrew:
        name: mkcert
        state: present
        path: "{{ homebrew_path }}"
      register: brew_mkcert_result
      until: brew_mkcert_result is success
      retries: 3
      delay: 2
      become: false

# Common for both platforms
- name: Initialize mkcert
  ansible.builtin.command: mkcert -install
  register: mkcert_init
  changed_when: mkcert_init.rc == 0
  become_user: "{{ username }}"
  become: true
