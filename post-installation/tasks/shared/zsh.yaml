---
- name: Install zsh (Linux)
  ansible.builtin.apt:
    name: zsh
  register: apt_zsh_result
  until: apt_zsh_result is success
  retries: 3
  delay: 2
  when: ansible_os_family == 'Debian'

- name: Install zsh (macOS)
  community.general.homebrew:
    name: zsh
    state: present
    path: "{{ homebrew_path }}"
  register: brew_zsh_result
  until: brew_zsh_result is success
  retries: 3
  delay: 2
  become: false
  when: ansible_os_family == 'Darwin'

- name: Save ZSH install location into a variable
  ansible.builtin.command: which zsh
  register: zsh_install_path
  changed_when: false
  failed_when: false

- name: Set fallback ZSH path if which command failed
  ansible.builtin.set_fact:
    zsh_path: "{{ zsh_install_path.stdout if zsh_install_path.rc == 0 and zsh_install_path.stdout else zsh_executable }}"

- name: Set ZSH as default login shell for current user
  ansible.builtin.user:
    name: "{{ username }}"
    shell: "{{ zsh_path }}"
  register: shell_change_result
  failed_when: false
  ignore_errors: true

- name: Validate ZSH installation path
  ansible.builtin.debug:
    msg: "Using ZSH path: {{ zsh_path }}"

- name: Log shell change succeeded
  ansible.builtin.debug:
    msg: "✅ Shell change succeeded - ZSH is now the default shell"
  when: shell_change_result.changed

- name: Log shell change failed or skipped
  ansible.builtin.debug:
    msg: "ℹ️  Shell change failed or skipped - this is normal in CI environments or if ZSH is already the default"
  when: not shell_change_result.changed

- name: Initialize .zshrc
  ansible.builtin.copy:
    src: ./defaults/.zshrc
    dest: "{{ zshrc }}"
    mode: "0644"
  become_user: "{{ username }}"
  become: true

- name: Create ~/.zsh/aliases directory
  ansible.builtin.file:
    path: "{{ user_home }}/.zsh/aliases"
    state: directory
    mode: "0755"
  become_user: "{{ username }}"
  become: true

- name: Copy aliases files to ~/.zsh/aliases
  ansible.builtin.copy:
    src: ./defaults/.zsh/aliases
    dest: "{{ user_home }}/.zsh"
    mode: "0644"
  become_user: "{{ username }}"
  become: true

- name: Create functions directory
  ansible.builtin.file:
    path: "{{ user_home }}/.zsh/functions"
    state: directory
    mode: "0755"
  become_user: "{{ username }}"
  become: true

- name: Copy functions files to ~/.zsh/functions
  ansible.builtin.copy:
    src: "./defaults/.zsh/functions"
    dest: "{{ user_home }}/.zsh"
    mode: "0644"
    force: true
  become_user: "{{ username }}"
  become: true

- name: Create ~/.zsh/completions directory
  ansible.builtin.file:
    path: "{{ user_home }}/.zsh/completions"
    state: directory
    mode: "0755"
  become_user: "{{ username }}"
  become: true

- name: Copy completions files to ~/.zsh/completions
  ansible.builtin.copy:
    src: "./defaults/.zsh/completions"
    dest: "{{ user_home }}/.zsh"
    mode: "0644"
  become_user: "{{ username }}"
  become: true

- name: Copy .p10k.zsh
  ansible.builtin.copy:
    src: ./defaults/.p10k.zsh
    dest: "{{ user_home }}"
    mode: "0644"
  become_user: "{{ username }}"
  become: true

- name: Install antidote (ZSH plugin manager)
  block:
    - name: Delete existing antidote directory
      ansible.builtin.file:
        path: "{{ user_home }}/.antidote"
        state: absent
      become_user: "{{ username }}"
      become: true

    - name: Clone antidote repository
      ansible.builtin.git:
        repo: https://github.com/mattmc3/antidote.git
        dest: "{{ user_home }}/.antidote"
        depth: 1
        force: true
      become_user: "{{ username }}"
      become: true
      register: git_antidote_result
      until: git_antidote_result is success
      retries: 3
      delay: 2

- name: Configure antidote
  block:
    - name: Copy .zsh_plugins.sh
      ansible.builtin.copy:
        src: ./defaults/.zsh_plugins.sh
        dest: "{{ user_home }}/.zsh_plugins.sh"
        mode: "0644"
      become_user: "{{ username }}"
      become: true

    - name: Remove existing .zsh_plugins.zsh
      ansible.builtin.file:
        path: "{{ user_home }}/.zsh_plugins.zsh"
        state: absent

    - name: Copy configure_antidote.sh script
      ansible.builtin.copy:
        src: "{{ role_path }}/defaults/scripts/configure_antidote.sh"
        dest: "{{ download_dir }}/configure_antidote.sh"
        mode: "0755"
      become_user: "{{ username }}"
      become: true

    - name: Run configure_antidote.sh
      ansible.builtin.shell: |
        {{ download_dir }}/configure_antidote.sh "{{ user_home }}"
      args:
        executable: "{{ zsh_path }}"
      become_user: "{{ username }}"
      become: true
      register: antidote_update
      changed_when: antidote_update.rc == 0
  rescue:
    - name: Warn about Antidote failure
      ansible.builtin.debug:
        msg: "⚠️ Failed to configure Antidote or download bundles. Zsh plugins might not be available."
